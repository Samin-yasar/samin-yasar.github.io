<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Cinema Collection</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;1,400&family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet" />
<style>
  :root {
    --parchment: #f0f4f9;
    --paper: #ffffff;
    --ink: #1e293b;
    --ink-light: #475569;
    --blue: #3b82f6;
    --blue-dark: #1e40af;
    --blue-mid: #60a5fa;
    --blue-pale: #93c5fd;
    --blue-lightest: #dbeafe;
    --green: #10b981;
    --purple: #8b5cf6;
    --amber: #f59e0b;
    --red: #ef4444;
    --border: #e2e8f0;
    --border-med: #cbd5e1;
    --shadow: 0 1px 3px rgba(59,130,246,.08), 0 4px 12px rgba(59,130,246,.05);
    --shadow-up: 0 4px 16px rgba(59,130,246,.13), 0 8px 32px rgba(59,130,246,.08);
    --r: 8px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Crimson Pro', Georgia, serif;
    background: var(--parchment);
    background-image:
      repeating-linear-gradient(90deg,transparent,transparent 2px,rgba(0,0,0,.008) 2px,rgba(0,0,0,.008) 3px),
      repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.008) 2px,rgba(0,0,0,.008) 3px);
    color: var(--ink);
    min-height: 100vh;
    padding: 60px 24px 80px;
    -webkit-font-smoothing: antialiased;
    line-height: 1.7;
  }
  .wrapper { max-width: 1280px; margin: 0 auto; }

  /* HEADER */
  .header { text-align: center; margin-bottom: 56px; padding-bottom: 28px; position: relative; }
  .header::after {
    content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100px; height: 3px;
    background: linear-gradient(90deg, transparent, var(--blue), transparent);
  }
  .deco { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 10px; opacity: .55; }
  .deco-line { width: 48px; height: 1px; background: linear-gradient(90deg,transparent,var(--blue),transparent); }
  .header h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2.4rem, 6vw, 4.2rem); font-weight: 700;
    color: var(--blue-dark); letter-spacing: .3px; margin-bottom: 6px;
  }
  .header .sub { font-family: 'EB Garamond', serif; font-size: 1.15rem; font-style: italic; color: var(--ink-light); letter-spacing: .8px; }

  /* CARD */
  .card { background: var(--paper); border: 1px solid var(--border); border-radius: var(--r); box-shadow: var(--shadow); }

  /* TOOLBAR */
  .toolbar { padding: 22px 26px; margin-bottom: 20px; }
  .toolbar-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
  .sw { flex: 1; min-width: 220px; position: relative; }
  .sw input {
    width: 100%; padding: 12px 42px 12px 16px;
    font-family: 'Crimson Pro', serif; font-size: 1rem;
    border: 2px solid var(--border-med); border-radius: var(--r);
    background: var(--parchment); color: var(--ink); transition: all .25s;
  }
  .sw input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,.1); }
  .sw svg { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 17px; height: 17px; color: var(--ink-light); pointer-events: none; }
  .sel {
    padding: 12px 34px 12px 16px; font-family: 'Crimson Pro', serif; font-size: 1rem;
    border: 2px solid var(--border-med); border-radius: var(--r);
    background: var(--parchment); color: var(--ink); cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='3 6 7 10 11 6'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center; transition: all .25s;
  }
  .sel:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,.1); }
  .vtog { display: flex; padding: 3px; gap: 4px; background: var(--parchment); border: 2px solid var(--border-med); border-radius: var(--r); }
  .vb { padding: 8px 13px; border: none; background: transparent; cursor: pointer; border-radius: 4px; color: var(--ink-light); transition: all .2s; display: flex; align-items: center; }
  .vb:hover { background: rgba(59,130,246,.08); }
  .vb.on { background: var(--blue); color: #fff; }
  .vb svg { width: 18px; height: 18px; }

  /* FILTER PANEL */
  .fp { padding: 22px 26px; margin-bottom: 20px; }
  .fp-sec { margin-bottom: 18px; }
  .fp-sec:last-of-type { margin-bottom: 0; }
  .fp-lbl { font-family: 'Cormorant Garamond', serif; font-size: 1.15rem; font-weight: 600; color: var(--blue-dark); margin-bottom: 10px; display: flex; align-items: center; gap: 7px; }
  .fp-opts { display: flex; flex-wrap: wrap; gap: 8px; }
  .cbp {
    display: flex; align-items: center; gap: 6px; padding: 7px 14px;
    border: 2px solid var(--border-med); border-radius: 999px; background: var(--parchment);
    cursor: pointer; user-select: none; transition: all .2s;
  }
  .cbp:hover { border-color: var(--blue); background: var(--paper); }
  .cbp.on { border-color: var(--blue); background: var(--blue-lightest); }
  .cbp input { width: 15px; height: 15px; accent-color: var(--blue); cursor: pointer; pointer-events: none; }
  .cbp label { cursor: pointer; font-size: .9rem; font-weight: 500; color: var(--ink); pointer-events: none; }
  .fp-actions { display: flex; align-items: center; gap: 12px; margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--border); flex-wrap: wrap; }
  .fpbtn { padding: 7px 16px; border: 2px solid var(--border-med); border-radius: var(--r); background: var(--parchment); color: var(--ink); font-size: .88rem; font-weight: 500; cursor: pointer; transition: all .2s; font-family: 'Crimson Pro', serif; }
  .fpbtn:hover { border-color: var(--blue); background: var(--paper); }
  .fpbtn.pri { background: var(--blue); border-color: var(--blue); color: #fff; }
  .fpbtn.pri:hover { background: var(--blue-dark); border-color: var(--blue-dark); }
  .fp-active-label { font-size: .88rem; color: var(--ink-light); font-style: italic; }

  /* GOALS */
  .goals { padding: 26px 30px; margin-bottom: 20px; position: relative; overflow: hidden; }
  .goals::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--blue-dark), var(--blue), var(--blue-mid)); }
  .g-title { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; font-weight: 600; color: var(--blue-dark); margin-bottom: 18px; display: flex; align-items: center; gap: 10px; }
  .g-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .gc { padding: 16px 18px; background: var(--parchment); border: 1px solid var(--border); border-radius: var(--r); }
  .gc-t { font-size: .82rem; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--ink-light); margin-bottom: 6px; }
  .gc-n { font-family: 'Cormorant Garamond', serif; font-size: 2.2rem; font-weight: 600; color: var(--blue-dark); margin-bottom: 8px; line-height: 1; }
  .bar { height: 7px; background: var(--border); border-radius: 999px; overflow: hidden; }
  .bar-f { height: 100%; background: linear-gradient(90deg, var(--blue-dark), var(--blue)); border-radius: 999px; transition: width .5s ease; }

  /* STATS */
  .stats { margin-bottom: 20px; }
  .sg { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
  .sc {
    background: var(--paper); border: 1px solid var(--border); padding: 18px 14px;
    border-radius: var(--r); box-shadow: var(--shadow); cursor: pointer;
    transition: all .28s cubic-bezier(.4,0,.2,1); position: relative; overflow: hidden;
  }
  .sc::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--blue); transform: scaleX(0); transition: transform .28s; }
  .sc:hover { transform: translateY(-3px); box-shadow: var(--shadow-up); }
  .sc:hover::after { transform: scaleX(1); }
  .sc.on { color: #fff; border-color: transparent; transform: translateY(-3px) scale(1.02); }
  .sc.on::after { transform: scaleX(1); background: rgba(255,255,255,.4); }
  .sc-n { font-family: 'Cormorant Garamond', serif; font-size: 2.4rem; font-weight: 700; display: block; margin-bottom: 2px; line-height: 1; }
  .sc-l { font-size: .8rem; text-transform: uppercase; letter-spacing: .7px; opacity: .8; font-weight: 500; }

  /* CHART */
  .cp { padding: 30px; margin-bottom: 28px; }
  .cp-h { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 14px; margin-bottom: 24px; }
  .cp-t { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; font-weight: 600; color: var(--blue-dark); display: flex; align-items: center; gap: 10px; }
  .pills { display: flex; gap: 7px; flex-wrap: wrap; }
  .pill { padding: 6px 16px; border-radius: 999px; border: 2px solid var(--border-med); background: var(--parchment); font-size: .87rem; font-weight: 500; cursor: pointer; transition: all .22s; color: var(--ink); font-family: 'Crimson Pro', serif; }
  .pill:hover { border-color: var(--blue); background: var(--paper); }
  .pill.on { background: var(--blue); color: #fff; border-color: var(--blue); }
  .cw { width: 100%; height: 210px; }
  canvas#chart { width: 100%; height: 100%; display: block; }
  .cn { text-align: center; margin-top: 16px; font-size: 1rem; color: var(--ink-light); font-style: italic; }
  .cn strong { color: var(--blue-dark); font-weight: 600; }

  /* MOVIE CARDS */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap: 26px; margin-top: 26px; }
  .grid.lv { grid-template-columns: 1fr; }
  .mc {
    background: var(--paper); border: 1px solid var(--border); border-radius: var(--r);
    overflow: hidden; box-shadow: var(--shadow);
    transition: all .3s cubic-bezier(.4,0,.2,1);
    animation: pop .36s ease-out backwards;
  }
  @keyframes pop { from { opacity:0; transform:translateY(16px) scale(.96); } to { opacity:1; transform:none; } }
  .mc:nth-child(1){animation-delay:.04s}.mc:nth-child(2){animation-delay:.08s}
  .mc:nth-child(3){animation-delay:.12s}.mc:nth-child(4){animation-delay:.16s}
  .mc:nth-child(5){animation-delay:.20s}.mc:nth-child(6){animation-delay:.24s}
  .mc:hover { transform: translateY(-5px) scale(1.008); box-shadow: 0 10px 28px rgba(59,130,246,.14), 0 18px 40px rgba(59,130,246,.09); border-color: var(--blue); }

  .strip { height: 6px; }

  /* list mode */
  .grid.lv .mc { display: flex; }
  .grid.lv .strip { width: 6px; height: auto; flex-shrink: 0; }
  .grid.lv .mc-body { flex: 1; display: grid; grid-template-columns: 1.8fr 1fr; }
  .grid.lv .mc-main { padding: 26px; border-right: 1px solid var(--border); }
  .grid.lv .mc-side { padding: 26px; }
  /* grid mode */
  .grid:not(.lv) .mc-body { padding: 26px; }

  .mc-title { font-family: 'Cormorant Garamond', serif; font-size: 1.45rem; font-weight: 700; color: var(--blue-dark); line-height: 1.3; margin-bottom: 3px; }
  .mc-dir   { font-style: italic; font-size: .98rem; color: var(--ink-light); margin-bottom: 3px; }
  .mc-yr    { font-size: .88rem; color: var(--ink-light); margin-bottom: 12px; }
  .badge {
    display: inline-block; padding: 4px 13px; border-radius: 999px;
    font-size: .75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .4px;
    color: #fff; margin-bottom: 8px; vertical-align: middle;
  }
  .rw-badge {
    display: inline-flex; align-items: center; gap: 4px; padding: 3px 11px; border-radius: 999px;
    font-size: .76rem; font-weight: 600; background: var(--blue-lightest); color: var(--blue-dark);
    border: 1px solid var(--blue-pale); margin-left: 6px; margin-bottom: 8px; vertical-align: middle;
  }
  .rw-badge svg { width: 12px; height: 12px; }
  .genres { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
  .gtag { padding: 3px 10px; border-radius: 999px; font-size: .77rem; font-weight: 500; background: var(--blue-lightest); border: 1px solid var(--blue-pale); color: var(--blue-dark); }
  .stars { display: flex; align-items: center; gap: 3px; margin-bottom: 10px; }
  .star { width: 16px; height: 16px; }
  .slbl { margin-left: 6px; font-size: .86rem; color: var(--ink-light); font-weight: 500; }
  .meta { display: flex; flex-direction: column; gap: 7px; padding-top: 12px; border-top: 1px solid var(--border); margin-bottom: 12px; }
  .mr { display: flex; align-items: center; gap: 8px; font-size: .87rem; color: var(--ink-light); }
  .mr svg { width: 14px; height: 14px; flex-shrink: 0; color: var(--blue); }
  .nb { padding: 14px 16px; background: linear-gradient(to right, rgba(59,130,246,.07), rgba(59,130,246,.02)); border-left: 4px solid var(--blue); border-radius: 0 var(--r) var(--r) 0; margin-top: 12px; }
  .nl { font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--blue-dark); margin-bottom: 5px; }
  .nt { font-style: italic; line-height: 1.62; color: var(--ink); font-size: .94rem; }

  /* EMPTY */
  .empty { text-align: center; padding: 72px 28px; background: var(--paper); border: 2px dashed var(--border-med); border-radius: var(--r); margin: 28px 0; }
  .empty svg { width: 64px; height: 64px; color: var(--border-med); margin-bottom: 14px; opacity: .45; }
  .empty p { font-family: 'EB Garamond', serif; font-size: 1.2rem; font-style: italic; color: var(--ink-light); }

  /* FOOTER */
  .footer { text-align: center; margin-top: 68px; padding-top: 26px; border-top: 1px solid var(--border); color: var(--ink-light); font-size: .9rem; }
  .fl { width: 52px; height: 2px; background: linear-gradient(90deg, transparent, var(--blue), transparent); margin: 12px auto; }

  /* LOADER */
  .loader { min-height: 70vh; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; }
  .spin { width: 44px; height: 44px; border: 3px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: rot 1s linear infinite; }
  @keyframes rot { to { transform: rotate(360deg); } }
  .ltxt { font-family: 'EB Garamond', serif; font-size: 1.2rem; font-style: italic; color: var(--ink-light); }

  @media (max-width: 768px) {
    body { padding: 36px 14px 60px; }
    .toolbar { padding: 16px 18px; }
    .toolbar-row { flex-direction: column; align-items: stretch; }
    .sw { min-width: 100%; }
    .fp, .goals, .cp { padding: 18px; }
    .grid { grid-template-columns: 1fr; gap: 18px; }
    .grid.lv .mc-body { grid-template-columns: 1fr; }
    .grid.lv .mc-main { border-right: none; border-bottom: 1px solid var(--border); }
    .sg { grid-template-columns: repeat(2,1fr); }
    .g-grid { grid-template-columns: repeat(2,1fr); }
  }
  @media (max-width: 480px) {
    .sg { grid-template-columns: 1fr; }
    .g-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="wrapper" id="app">
  <div class="loader"><div class="spin"></div><p class="ltxt">Loading your cinema collection…</p></div>
</div>

<svg style="display:none"><defs>
  <symbol id="i-film" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="2" y="2" width="20" height="20" rx="2"/>
    <line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/>
    <line x1="2" y1="12" x2="22" y2="12"/>
    <line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/>
    <line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/>
  </symbol>
  <symbol id="i-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
  </symbol>
  <symbol id="i-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
  </symbol>
  <symbol id="i-cal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="4" width="18" height="18" rx="2"/>
    <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
  </symbol>
  <symbol id="i-star-f" viewBox="0 0 24 24" fill="#fbbf24" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
  </symbol>
  <symbol id="i-star-e" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
  </symbol>
  <symbol id="i-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
  </symbol>
  <symbol id="i-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
    <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
  </symbol>
  <symbol id="i-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
  </symbol>
  <symbol id="i-rep" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="17 1 21 5 17 9"/>
    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
    <polyline points="7 23 3 19 7 15"/>
    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
  </symbol>
</defs></svg>

<script>
// ══════════════════════════════════
// CONFIG
// ══════════════════════════════════
const STATUSES = [
  { id:'watching',  label:'Watching',       color:'#3b82f6' },
  { id:'watched',   label:'Watched',         color:'#10b981' },
  { id:'planwatch', label:'Plan to Watch',   color:'#8b5cf6' },
  { id:'hold',      label:'On Hold',         color:'#f59e0b' },
  { id:'dropped',   label:'Dropped',         color:'#ef4444' }
];

const MONTHS = [
  {n:1,name:'Jan'},{n:2,name:'Feb'},{n:3,name:'Mar'},{n:4,name:'Apr'},
  {n:5,name:'May'},{n:6,name:'Jun'},{n:7,name:'Jul'},{n:8,name:'Aug'},
  {n:9,name:'Sep'},{n:10,name:'Oct'},{n:11,name:'Nov'},{n:12,name:'Dec'}
];

// ══════════════════════════════════
// STATE
// ══════════════════════════════════
let movies   = [];
let sfilt    = 'all';
let tv       = 'month';
let vm       = 'grid';
let sq       = '';
let sort     = 'date';
let selY     = [];
let selM     = [];

// ══════════════════════════════════
// LOAD
// ══════════════════════════════════
async function load() {
  try {
    const r = await fetch('movielist.json');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const d = await r.json();
    movies = d.movies || d || [];
    render();
  } catch(e) {
    document.getElementById('app').innerHTML =
      `<div class="empty" style="margin-top:80px">
        <svg><use href="#i-film"/></svg>
        <p style="color:#ef4444;font-weight:600;margin-bottom:8px">Cannot load movielist.json</p>
        <p>Place movielist.json in the same folder as this HTML file.</p>
        <p style="font-size:.85rem;opacity:.6;margin-top:10px">${e.message}</p>
       </div>`;
  }
}

// ══════════════════════════════════
// STATS
// ══════════════════════════════════
function wstats() {
  const now  = new Date();
  const tod  = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const m0   = new Date(now.getFullYear(), now.getMonth(), 1);
  const y0   = new Date(now.getFullYear(), 0, 1);
  let day=0, mon=0, yr=0, all=0;
  movies.forEach(m => {
    const t = +(m.watchTime) || 0;
    if (!t) return;
    all += t;
    const d = m.endDate ? new Date(m.endDate) : (m.startDate ? new Date(m.startDate) : null);
    if (!d) return;
    if (d >= tod) day += t;
    if (d >= m0)  mon += t;
    if (d >= y0)  yr  += t;
  });
  return {day, mon, yr, all};
}
function avgR() {
  const r = movies.filter(m => m.rating > 0);
  return r.length ? (r.reduce((s,m)=>s+m.rating,0)/r.length).toFixed(1) : 0;
}
function yGoal() {
  const y = new Date().getFullYear();
  const n = movies.filter(m => m.status==='watched' && m.endDate && new Date(m.endDate).getFullYear()===y).length;
  return {n, g:52, pct: Math.min(n/52*100,100)};
}
function tGoal() {
  const {yr} = wstats(); const g=200;
  return {n:yr, g, pct: Math.min(yr/g*100,100)};
}

// ══════════════════════════════════
// FILTER HELPERS
// ══════════════════════════════════
function mYear(m)  { const d=m.endDate||m.startDate; return d ? new Date(d).getFullYear() : null; }
function mMonth(m) { const d=m.endDate||m.startDate; return d ? new Date(d).getMonth()+1  : null; }
function allYears(){ return [...new Set(movies.map(mYear).filter(Boolean))].sort((a,b)=>b-a); }

function getFiltered() {
  let f = movies.slice();
  if (sfilt !== 'all')  f = f.filter(m => m.status === sfilt);
  if (selY.length)      f = f.filter(m => { const y=mYear(m);  return y  && selY.includes(y); });
  if (selM.length)      f = f.filter(m => { const mo=mMonth(m); return mo && selM.includes(mo); });
  if (sq.trim()) {
    const q = sq.toLowerCase();
    f = f.filter(m =>
      m.title.toLowerCase().includes(q) ||
      (m.director||'').toLowerCase().includes(q) ||
      (m.genre||[]).some(g => g.toLowerCase().includes(q)) ||
      (m.notes||'').toLowerCase().includes(q)
    );
  }
  return f.sort((a,b) => {
    if (sort==='title')  return a.title.localeCompare(b.title);
    if (sort==='rating') return (b.rating||0)-(a.rating||0);
    if (sort==='time')   return (b.watchTime||0)-(a.watchTime||0);
    const da = a.endDate||a.startDate||'1900-01-01';
    const db = b.endDate||b.startDate||'1900-01-01';
    return db.localeCompare(da);
  });
}

// ══════════════════════════════════
// CHART
// ══════════════════════════════════
function drawChart() {
  const cv = document.getElementById('chart');
  if (!cv) return;
  const ctx = cv.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  const rect = cv.parentElement.getBoundingClientRect();
  const W = rect.width, H = rect.height||210;
  cv.width=W*dpr; cv.height=H*dpr;
  cv.style.width=W+'px'; cv.style.height=H+'px';
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);

  const st = wstats();
  const vals = {day:st.day, month:st.mon, year:st.yr, alltime:st.all};
  const labs = {day:'Today', month:'This Month', year:'This Year', alltime:'All Time'};
  const keys = ['day','month','year','alltime'];
  const p = {t:24,r:26,b:40,l:46};
  const cW=W-p.l-p.r, cH=H-p.t-p.b;
  const mx = Math.max(...keys.map(k=>vals[k]),1);

  ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
  ctx.fillStyle='#475569'; ctx.font='11px "Crimson Pro",serif'; ctx.textAlign='right';
  for (let i=0;i<=5;i++) {
    const y=p.t+cH-(cH*i/5);
    ctx.beginPath(); ctx.moveTo(p.l,y); ctx.lineTo(W-p.r,y); ctx.stroke();
    ctx.fillText((mx*i/5).toFixed(0)+'h', p.l-6, y+4);
  }

  const bW = Math.min(cW/keys.length*.6,86);
  const gW = (cW-bW*keys.length)/(keys.length+1);
  keys.forEach((k,i) => {
    const bH=(vals[k]/mx)*cH, x=p.l+gW*(i+1)+bW*i, y=p.t+cH-bH;
    const act = k===tv;
    const g2 = ctx.createLinearGradient(x,y,x,y+bH);
    if(act){ g2.addColorStop(0,'#1e40af'); g2.addColorStop(1,'#3b82f6'); }
    else   { g2.addColorStop(0,'#e2e8f0'); g2.addColorStop(1,'#cbd5e1'); }
    ctx.fillStyle=g2;
    const r=5;
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.lineTo(x+bW-r,y); ctx.quadraticCurveTo(x+bW,y,x+bW,y+r);
    ctx.lineTo(x+bW,y+bH); ctx.lineTo(x,y+bH); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='#1e293b'; ctx.font='600 12px "Crimson Pro",serif'; ctx.textAlign='center';
    ctx.fillText(vals[k].toFixed(1)+'h', x+bW/2, y-7);
    ctx.fillStyle=act?'#1e40af':'#475569';
    ctx.font=(act?'600 ':'400 ')+'11px "Crimson Pro",serif';
    ctx.fillText(labs[k], x+bW/2, p.t+cH+24);
  });
}

// ══════════════════════════════════
// HELPERS
// ══════════════════════════════════
const iFilm = `<svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><use href="#i-film"/></svg>`;
const iClk  = sz => `<svg width="${sz}" height="${sz}"><use href="#i-clock"/></svg>`;
const iCal  = sz => `<svg width="${sz}" height="${sz}"><use href="#i-cal"/></svg>`;
const iTgt  = sz => `<svg width="${sz}" height="${sz}"><use href="#i-target"/></svg>`;
const iRep  = sz => `<svg width="${sz}" height="${sz}"><use href="#i-rep"/></svg>`;

function stars(rating) {
  if (!rating||rating<=0) return '';
  let h='<div class="stars">';
  for(let i=1;i<=5;i++) {
    h += `<svg class="star"><use href="#i-star-${i<=rating?'f':'e'}"/></svg>`;
  }
  h += `<span class="slbl">${parseFloat(rating).toFixed(1)}/5</span></div>`;
  return h;
}

function fmt(s) {
  if(!s) return null;
  return new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

// ══════════════════════════════════
// RENDER
// ══════════════════════════════════
function render() {
  const app = document.getElementById('app');
  const counts = {all: movies.length};
  STATUSES.forEach(s => { counts[s.id] = movies.filter(m=>m.status===s.id).length; });

  const list   = getFiltered();
  const st     = wstats();
  const avg    = avgR();
  const yg     = yGoal();
  const tg     = tGoal();
  const years  = allYears();
  const totalRW = movies.reduce((s,m)=>s+(+(m.rewatchCount)||0),0);
  const activeFilters = [...selY.map(String), ...selM.map(n=>MONTHS[n-1].name)];

  app.innerHTML = `
<header class="header">
  <div class="deco"><div class="deco-line"></div>${iFilm}<div class="deco-line"></div></div>
  <h1>My Cinema Collection</h1>
  <p class="sub">A curated journey through the art of film</p>
</header>

<!-- toolbar -->
<div class="card toolbar">
  <div class="toolbar-row">
    <div class="sw">
      <input id="sIn" type="text" placeholder="Search title, director, genre…" value="${sq.replace(/"/g,'&quot;')}">
      <svg><use href="#i-search"/></svg>
    </div>
    <select class="sel" id="sortSel">
      <option value="date"   ${sort==='date'  ?'selected':''}>Recently Watched</option>
      <option value="title"  ${sort==='title' ?'selected':''}>Title A–Z</option>
      <option value="rating" ${sort==='rating'?'selected':''}>Highest Rated</option>
      <option value="time"   ${sort==='time'  ?'selected':''}>Most Watch Time</option>
    </select>
    <div class="vtog">
      <button class="vb ${vm==='grid'?'on':''}" data-v="grid" title="Grid"><svg><use href="#i-grid"/></svg></button>
      <button class="vb ${vm==='list'?'on':''}" data-v="list" title="List"><svg><use href="#i-list"/></svg></button>
    </div>
  </div>
</div>

<!-- filters -->
<div class="card fp">
  <div class="fp-sec">
    <div class="fp-lbl">${iCal(17)} Filter by Year</div>
    <div class="fp-opts" id="fpY">
      ${years.length ? years.map(y=>`
        <div class="cbp ${selY.includes(y)?'on':''}" data-year="${y}">
          <input type="checkbox" id="y${y}" ${selY.includes(y)?'checked':''}>
          <label for="y${y}">${y}</label>
        </div>`).join('')
        : '<em style="font-size:.88rem;color:var(--ink-light)">No dated entries yet</em>'}
    </div>
  </div>
  <div class="fp-sec">
    <div class="fp-lbl">${iCal(17)} Filter by Month</div>
    <div class="fp-opts" id="fpM">
      ${MONTHS.map(mo=>`
        <div class="cbp ${selM.includes(mo.n)?'on':''}" data-month="${mo.n}">
          <input type="checkbox" id="m${mo.n}" ${selM.includes(mo.n)?'checked':''}>
          <label for="m${mo.n}">${mo.name}</label>
        </div>`).join('')}
    </div>
  </div>
  <div class="fp-actions">
    <button class="fpbtn pri" id="clearBtn">✕ Clear Filters</button>
    ${activeFilters.length ? `<span class="fp-active-label">Showing: ${activeFilters.join(', ')}</span>` : ''}
  </div>
</div>

<!-- goals -->
<div class="card goals">
  <h2 class="g-title">${iTgt(21)} Watching Goals</h2>
  <div class="g-grid">
    <div class="gc">
      <div class="gc-t">Movies This Year</div>
      <div class="gc-n">${yg.n} <span style="font-size:1.3rem;opacity:.5">/ ${yg.g}</span></div>
      <div class="bar"><div class="bar-f" style="width:${yg.pct}%"></div></div>
    </div>
    <div class="gc">
      <div class="gc-t">Watch Hours</div>
      <div class="gc-n">${st.yr.toFixed(1)}<span style="font-size:1.3rem;opacity:.5">h / ${tg.g}h</span></div>
      <div class="bar"><div class="bar-f" style="width:${tg.pct}%"></div></div>
    </div>
    <div class="gc">
      <div class="gc-t">Avg Rating</div>
      <div class="gc-n">${avg>0?avg:'—'}<span style="font-size:1.3rem;opacity:.5">${avg>0?' / 5':''}</span></div>
      <div class="bar"><div class="bar-f" style="width:${avg*20}%"></div></div>
    </div>
    <div class="gc">
      <div class="gc-t">Total Rewatches</div>
      <div class="gc-n">${totalRW}<span style="font-size:1.3rem;opacity:.5"> times</span></div>
      <div class="bar"><div class="bar-f" style="width:${Math.min(totalRW/10*100,100)}%"></div></div>
    </div>
  </div>
</div>

<!-- status cards -->
<div class="stats">
  <div class="sg" id="statBar">
    <div class="sc ${sfilt==='all'?'on':''}" data-s="all"
         style="${sfilt==='all'?'background:linear-gradient(135deg,#1e40af,#3b82f6);border-color:#3b82f6':''}">>
      <span class="sc-n">${counts.all}</span>
      <span class="sc-l">All</span>
    </div>
    ${STATUSES.map(s=>`
      <div class="sc ${sfilt===s.id?'on':''}" data-s="${s.id}"
           style="${sfilt===s.id?`background:linear-gradient(135deg,${s.color}dd,${s.color});border-color:${s.color}`:''}">
        <span class="sc-n">${counts[s.id]||0}</span>
        <span class="sc-l">${s.label}</span>
      </div>`).join('')}
  </div>
</div>

<!-- chart -->
<div class="card cp">
  <div class="cp-h">
    <h2 class="cp-t">${iClk(21)} Watch Analytics</h2>
    <div class="pills" id="pillRow">
      ${['day','month','year','alltime'].map(v=>`
        <button class="pill ${tv===v?'on':''}" data-tv="${v}">
          ${v==='alltime'?'All Time':v.charAt(0).toUpperCase()+v.slice(1)}
        </button>`).join('')}
    </div>
  </div>
  <div class="cw"><canvas id="chart"></canvas></div>
  <p class="cn">Total watch time: <strong>${st.all.toFixed(1)} hrs</strong>
    ${avg>0?` · Average rating: <strong>${avg} / 5</strong>`:''}
  </p>
</div>

<!-- movie cards -->
${list.length===0 ? `
  <div class="empty"><svg><use href="#i-film"/></svg>
  <p>No movies match your current filters</p></div>
` : `
  <div class="grid ${vm==='list'?'lv':''}" id="mcGrid">
    ${list.map(m => {
      const s  = STATUSES.find(x=>x.id===m.status)||STATUSES[0];
      const rw = m.rewatched || (+(m.rewatchCount)||0) > 0;
      const rwN= +(m.rewatchCount)||0;
      const top = `
        <div class="mc-title">${m.title}</div>
        ${m.director?`<div class="mc-dir">dir. ${m.director}</div>`:''}
        ${m.year?`<div class="mc-yr">${m.year}</div>`:''}
        <div style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;margin-bottom:6px">
          <span class="badge" style="background:${s.color}">${s.label}</span>
          ${rw?`<span class="rw-badge">${iRep(12)} Rewatched${rwN>1?` × ${rwN}`:''}</span>`:''}
        </div>
        ${m.genre&&m.genre.length?`<div class="genres">${m.genre.map(g=>`<span class="gtag">${g}</span>`).join('')}</div>`:''}
      `;
      const side = `
        ${stars(m.rating)}
        <div class="meta">
          ${m.watchTime?`<div class="mr">${iClk(14)}<span>${m.watchTime} hrs</span></div>`:''}
          ${m.startDate?`<div class="mr">${iCal(14)}<span>Started: ${fmt(m.startDate)}</span></div>`:''}
          ${m.endDate  ?`<div class="mr">${iCal(14)}<span>Watched: ${fmt(m.endDate)}</span></div>`:''}
        </div>
        ${(m.notes||'').trim()?`
          <div class="nb">
            <div class="nl">My Review</div>
            <div class="nt">"${(m.notes||'').trim()}"</div>
          </div>`:''}
      `;
      if(vm==='list') return `
        <div class="mc">
          <div class="strip" style="background:${s.color}"></div>
          <div class="mc-body">
            <div class="mc-main">${top}</div>
            <div class="mc-side">${side}</div>
          </div>
        </div>`;
      return `
        <div class="mc">
          <div class="strip" style="background:${s.color}"></div>
          <div class="mc-body">${top}${side}</div>
        </div>`;
    }).join('')}
  </div>
`}

<footer class="footer">
  <div class="fl"></div>
  <p>A personal collection of ${movies.length} film${movies.length!==1?'s':''}</p>
  <p style="margin-top:5px;font-size:.82rem;opacity:.58">
    Last updated: ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}
  </p>
</footer>`;

  // ── EVENTS ─────────────────────────────────────

  document.getElementById('sIn').addEventListener('input', e => { sq = e.target.value; render(); });
  document.getElementById('sortSel').addEventListener('change', e => { sort = e.target.value; render(); });

  document.querySelectorAll('.vb').forEach(b => b.addEventListener('click', () => {
    if (b.dataset.v && b.dataset.v !== vm) { vm = b.dataset.v; render(); }
  }));

  document.getElementById('statBar').addEventListener('click', e => {
    const c = e.target.closest('.sc');
    if (c && c.dataset.s) { sfilt = c.dataset.s; render(); }
  });

  document.getElementById('pillRow').addEventListener('click', e => {
    const b = e.target.closest('.pill');
    if (b) { tv = b.dataset.tv; render(); }
  });

  // Year pills — read the pill's current .on state BEFORE re-render wipes DOM
  document.getElementById('fpY').addEventListener('click', e => {
    const pill = e.target.closest('.cbp');
    if (!pill || !pill.dataset.year) return;
    const y = parseInt(pill.dataset.year);
    // if it's currently ON, remove it; otherwise add it
    if (pill.classList.contains('on')) selY = selY.filter(x => x !== y);
    else if (!selY.includes(y))        selY.push(y);
    render();
  });

  // Month pills — same pattern
  document.getElementById('fpM').addEventListener('click', e => {
    const pill = e.target.closest('.cbp');
    if (!pill || !pill.dataset.month) return;
    const mo = parseInt(pill.dataset.month);
    if (pill.classList.contains('on')) selM = selM.filter(x => x !== mo);
    else if (!selM.includes(mo))       selM.push(mo);
    render();
  });

  document.getElementById('clearBtn').addEventListener('click', () => { selY=[]; selM=[]; render(); });

  requestAnimationFrame(drawChart);
}

window.addEventListener('resize', () => requestAnimationFrame(drawChart));
load();
</script>
</body>
</html>
